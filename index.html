<html>
  <head>
    <title>Sunday</title>
    <script src="https://unpkg.com/stein-js-client"></script>
    <style>
      table, tr, td {
        border: 1px solid;
        border-color: lightgray;
      }
    </style>
  </head>
  <body>
  <!--  <div id="acpSignal" style="font-size: 40px;"></div> -->
    <div id="acpBlurb1"></div>
    <div id="acpTable"></div>
    <div id="acpBlurb2"></div>
    <hr/>
    <div id="acpTable2"></div>
    <hr/>
    <div id="acpTable3"></div>


    <script>
////////////////////////////////////////////////////////////////////////////////////////
function ddmmyyyyToYyyymmdd(dateStr) {
  //Converts date string in form dd/mm/yyyy to date string in form yyyymmdd.
  const [dd, mm, yyyy] = dateStr.split('/');
  return `${yyyy}${mm}${dd}`;
}

////////////////////////////////////////////////////////////////////////////////////////
function ddmmyyyyToYyyydashmmdashdd(dateStr) {
  //Converts date string in form dd/mm/yyyy to date string in form yyyymmdd.
  const [dd, mm, yyyy] = dateStr.split('/');
  return `${yyyy}-${mm}-${dd}`;
}

//console.log(ddmmyyyyToYyyymmdd("31/12/2025")); // "20251231"
////////////////////////////////////////////////////////////////////////////////////////  
function convertDDMMYYYToDate(dateStr) {
  //Converts date string in form dd/mm/yyyy to a JS date.
  const parts = dateStr.split('/');
  // parts[0] = day, parts[1] = month, parts[2] = year
  return new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
}
////////////////////////////////////////////////////////////////////////////////////////
function addDays(date, days) {
  //Adds a number of days to a date.
  const result = new Date(date);       // Clone the original date to avoid mutation
  result.setDate(result.getDate() + days);  // Add the number of days
  return result;
}

      ////////////////////////////////////////////////////////////////////////////////////////

function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Earth's radius in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Interpolate lat/lon between two points by ratio (0-1)
function interpolatePoint(p1Lat, p1Lon, p2Lat, p2Lon, ratio) {
  return {
    lat: p1Lat + (p2Lat - p1Lat) * ratio,
    lon: p1Lon + (p2Lon - p1Lon) * ratio
  };
}
      
function getPositionAfterDistance(trackPoints, targetKm) {
  let cumulativeDist = 0;
  
  for (let i = 1; i < trackPoints.length; i++) {
    const prevLat = trackPoints[i-1].getAttribute("lat");
    const currLat = trackPoints[i].getAttribute("lat");
    const prevLon = trackPoints[i-1].getAttribute("lon");
    const currLon = trackPoints[i].getAttribute("lon");
   const segDist = haversineDistance(prevLat, prevLon, currLat, currLon);
    
    if (cumulativeDist + segDist >= targetKm) {
      //const remainingDist = targetKm - cumulativeDist;
      //const ratio = remainingDist / segDist;
      return {lat: currLat, lon: currLon};
    }
    
    cumulativeDist += segDist;
  }
  
  // If target exceeds total distance, return last point
  return {
    lat: trackPoints[trackPoints.length - 1].getAttribute("lat"),
    lon: trackPoints[trackPoints.length - 1].getAttribute("lon")};
}
      
      ////////////////////////////////////////////////////////////////////////////////////////
  async function getGpxBounds(gpxFilename) {
  try {
    // Fetch the GPX file as text from the server
    const response = await fetch(gpxFilename);
    if (!response.ok) {
      throw new Error(`Failed to fetch GPX file: ${response.status}`);
    }
    const gpxText = await response.text();
    
    // Parse the GPX XML content
    const parser = new DOMParser();
    const gpxDoc = parser.parseFromString(gpxText, 'text/xml');
    
    // Extract all trackpoint elements (<trkpt>)
    const trackPoints = Array.from(gpxDoc.getElementsByTagName('trkpt'));
    
    if (trackPoints.length === 0) {
      throw new Error('No trackpoints found in GPX file');
    }

    const at8am = getPositionAfterDistance(trackPoints, 0);
    const at9am = getPositionAfterDistance(trackPoints, 20);
    const at10am = getPositionAfterDistance(trackPoints, 40);
    const at11am = getPositionAfterDistance(trackPoints, 60);
    const at12am = getPositionAfterDistance(trackPoints, 80);
    const at13am = getPositionAfterDistance(trackPoints, 100);
    
    
    // Initialize bounds with first point
    const firstPoint = trackPoints[0];
    let minLat = parseFloat(firstPoint.getAttribute('lat'));
    let maxLat = minLat;
    let minLon = parseFloat(firstPoint.getAttribute('lon'));
    let maxLon = minLon;
    
    // Iterate through all trackpoints to find bounds
    for (let i = 1; i < trackPoints.length; i++) {
      const point = trackPoints[i];
      const lat = parseFloat(point.getAttribute('lat'));
      const lon = parseFloat(point.getAttribute('lon'));
      
      if (lat < minLat) minLat = lat;
      if (lat > maxLat) maxLat = lat;
      if (lon < minLon) minLon = lon;
      if (lon > maxLon) maxLon = lon;
    }
    
    return {
      minLat,
      maxLat,
      minLon,
      maxLon
    };
  } catch (error) {
    console.error('Error processing GPX file:', error);
    throw error;
  }
}

      ////////////////////////////////////////////////////////////////////////////////////////
  async function getGpxPts(gpxFilename, departHour, departMins, departDistance) {
  try {
    // Fetch the GPX file as text from the server
    const response = await fetch(gpxFilename);
    if (!response.ok) {
      throw new Error(`Failed to fetch GPX file: ${response.status}`);
    }
    const gpxText = await response.text();
    
    // Parse the GPX XML content
    const parser = new DOMParser();
    const gpxDoc = parser.parseFromString(gpxText, 'text/xml');
    
    // Extract all trackpoint elements (<trkpt>)
    const trackPoints = Array.from(gpxDoc.getElementsByTagName('trkpt'));
    
    if (trackPoints.length === 0) {
      throw new Error('No trackpoints found in GPX file');
    }
    
       let dist7 = Math.min(Math.max((7*60 - (departHour*60 + departMins))/60, 0)*20, departDistance);
       let dist8 = Math.min(Math.max((8*60 - (departHour*60 + departMins))/60, 0)*20, departDistance);
       let dist9 = Math.min(Math.max((9*60 - (departHour*60 + departMins))/60, 0)*20, departDistance);
       let dist10 = Math.min(Math.max((10*60 - (departHour*60 + departMins))/60, 0)*20, departDistance);
       let dist11 = Math.min(Math.max((11*60 - (departHour*60 + departMins))/60, 0)*20, departDistance);
       let dist12 = Math.min(Math.max((12*60 - (departHour*60 + departMins))/60, 0)*20, departDistance);
       let dist13 = Math.min(Math.max((13*60 - (departHour*60 + departMins))/60, 0)*20, departDistance);


    const at7 = getPositionAfterDistance(trackPoints, dist7);
    const at8 = getPositionAfterDistance(trackPoints, dist8);
    const at9 = getPositionAfterDistance(trackPoints, dist9);
    const at10 = getPositionAfterDistance(trackPoints, dist10);
    const at11 = getPositionAfterDistance(trackPoints, dist11);
    const at12 = getPositionAfterDistance(trackPoints, dist12);
    const at13 = getPositionAfterDistance(trackPoints, dist13);

    console.log("at7: ", at7);
    console.log("at8: ", at8);
    console.log("at9: ", at9);
    console.log("at10: ", at10);
    console.log("at11: ", at11);
    console.log("at12: ", at12);
    console.log("at13: ", at13);
       
    return {
      at7, at8, at9, at10, at11, at12, at13
    };
  } catch (error) {
    console.error('Error processing GPX file:', error);
    throw error;
  }
}

      ////////////////////////////////////////////////////////////////////////////////////////
async function main() {
        
  const thisDate = new Date();
  const thisYear = thisDate.getFullYear();
  let nextMonth, yearOfNextMonth;
  //console.log(thisDate.getMonth());
  if (thisDate.getMonth() == 11) { //December - months are counted from zero
    nextMonth = new Date(thisYear + 1, 0, 1);
    yearOfNextMonth = thisYear + 1;
  } else {
    nextMonth = new Date(thisYear, thisDate.getMonth() + 1, 1);
    yearOfNextMonth = thisYear;
  }
  const thismonthNameFrench = thisDate.toLocaleString('fr-FR', { month: 'long' });
  const nextmonthNameFrench = nextMonth.toLocaleString('fr-FR', { month: 'long' });
    
  const store = new SteinStore(
    "https://api.steinhq.com/v1/storages/692da1acaffba40a62246e38"
  );

  let data2025, data2026, data;
  
  /*try {
    data2025 = await store.read("Ride Plan 2025");
 } catch (error) {
    console.error("Failed to load ride data:", error);
  } //try-catch*/
   try {
    data2026 = await store.read("Ride Plan 2026");
 } catch (error) {
    console.error("Failed to load ride data:", error);
  } //try-catch
  
const getValidLength = (arr) => {
  return arr.findIndex(row => 
    !row ||                           // Empty row
    row.Date == null ||               // null/undefined
    row.Date === '' ||                // Empty string
    row.Date === 'null'               // String "null"
  );
};


//const len2025 = getValidLength(data2025);
const len2026 = getValidLength(data2026);
  data = [
//  ...data2025.slice(0, len2025),
  ...data2026.slice(0, len2026)
];
  
 // Next date...
  for (const row of data) {
 //       if (row.Date == null) break;  //Stop at the end of the year.
 //             console.log(convertDDMMYYYToDate(row.Date));
        if (convertDDMMYYYToDate(row.Date) > thisDate) {
          let theDate2 = convertDDMMYYYToDate(row.Date).getDate();
          let imageFilename = '/Sunday/images/'+ddmmyyyyToYyyymmdd(row.Date)+'.png';
          let thisMonth = new Date(convertDDMMYYYToDate(row.Date).getFullYear(), convertDDMMYYYToDate(row.Date).getMonth(), 1);
          let thisYear = convertDDMMYYYToDate(row.Date).getFullYear();
          const monthNameFrench2 = thisMonth.toLocaleString('fr-FR', { month: 'long' });
          const hour = row.HeuredeDepart.substring(0,2)+"h"+row.HeuredeDepart.substring(3,5);
          const url = 'https://chr1sg1thub.github.io/TownsOnMap/index.html?gpxFile='+row.Parcours+'.gpx&clat='+row.PCLat+'&clon='+row.PCLon+'&dist='+row.Distance+'&deniv='+row.Denivele;

          const gpxFile = "https://raw.githubusercontent.com/Chr1sG1thub/TownsOnMap/main/gpx/"+row.Parcours+".gpx";
          
          departHour = parseInt(row.HeuredeDepart.substring(0,2));
          departMins = parseInt(row.HeuredeDepart.substring(3,5));
          departDistance = parseFloat(row.Distance);

let hourPts = await getGpxPts(gpxFile, departHour, departMins, departDistance);
  
          document.getElementById("acpBlurb1").innerHTML =
                `<p style="font-family: Verdana, Geneva, sans-serif; font-size: 24px">Sortie du dimanche ${theDate2} ${monthNameFrench2} ${thisYear}</p><div style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">
                 <img src = "ACP Logo.png" width=142px>&nbsp;Bonjour √† toutes et tous,<br/><br/>
                 <span style="color: red"><strong>G1 et G2¬†rdv √† ${row.PointdeDepart} √† ${hour}.</strong></span>
                 <p>Le rendez-vous pour les sorties organis√©es par¬†le¬†club sont diffus√©es sur le blog et/ou Signal.
                 Si le lieu du¬†d√©part est modifi√© vous serez inform√©s via la messagerie du club.</p>

                 <p>Apr√®s la pause-caf√©, deux groupes pourront √™tre constitu√©s en fonction des participants et de leur niveau de forme.</p>
                 <p style="color: red"><strong>Parcours propos√© pour le G1 :</strong></p></div>`;
          const dateWithDashes = ddmmyyyyToYyyydashmmdashdd(row.Date);
        
          document.getElementById("acpTable").innerHTML =
                `<div style="font-family: Verdana, Geneva, sans-serif;">
                   <table width=100%>
                     <tr><td colspan=2 align=center><a href='${url}' target='_blank'><img src='${imageFilename}' width=90%></a><br>üëÄ&nbsp;<i>Pour une version zoomable, avec les Points d'Eau pr√®s de la route <img src='allwater.jpg' title='Toilette, Robinet, Fontaine, Autre' width=88px> cliquez <span style='background-color: yellow;'>sur la carte</span> ou <a href='${url}' target='_blank' style='font-size: 24px; background-color: yellow;'>ici</a>.</i>&nbsp;üëÄ<br/></td></tr>
                     <tr><td><strong>Parcours</strong></td><td>${row.Parcours}</td></tr>
                     <tr><td><strong>Parcours D√©taill√©</strong></td><td style="font-size: 10px;">${row.Details}</td></tr>
                     <tr><td><strong>Dist (km)</strong></td><td>${row.Distance}</td></tr>
                     <tr><td><strong>D√©niv (m)</strong></td><td>${row.Denivele}</td></tr>
                     <tr><td><strong>Caf√©</strong></td><td>${row.PauseCaf√©}</td></tr>
                     <tr><td><strong>M√©t√©o</strong></td><td><iframe width="560" src="https://chr1sg1thub.github.io/WeatherChart/indexCutDown?date=${dateWithDashes}&depart=${row.PointdeDepart}&lat7=${hourPts.at7.lat}&lon7=${hourPts.at7.lon}&lat8=${hourPts.at8.lat}&lon8=${hourPts.at8.lon}&lat9=${hourPts.at9.lat}&lon9=${hourPts.at9.lon}&lat10=${hourPts.at10.lat}&lon10=${hourPts.at10.lon}&lat11=${hourPts.at11.lat}&lon11=${hourPts.at11.lon}&lat12=${hourPts.at12.lat}&lon12=${hourPts.at12.lon}&lat13=${hourPts.at13.lat}&lon13=${hourPts.at13.lon}" frameborder="0"></iframe></td></tr>
                     <tr><td><strong>Itin√©raire</strong></td><td><a href="${row.Strava}" target="_blank">Itin√©raire</a></td></tr>
                     <tr><td><strong>Trace (GPX)</strong></td><td><a href="https://drive.google.com/file/d/${row.FileId}/view?usp=drive_link">Trace</a></td></tr>
                   </table>
                 </div>`;
       
          document.getElementById("acpBlurb2").innerHTML =
                `<div style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">
                   <p style="color: red"><strong>Parcours propos√© pour le G2</strong></p>
                   <p>(Voir Signal si pas de publication ici ‚Ä¶)</p>
                 </div>`;
          break;
        } //if (convertDDMMYYYToDate(row.Date)) > thisDate
      } //for (const row of data)
 
      let dayAndMonth;
      let thisMonth;
      let monthNameFrenchShort;
      let hour;
      let monthHTML;
          
      monthHTML = '<p style="font-family: Verdana, Geneva, sans-serif; font-size: 24px">Sorties (G1) programm√©es de '+thismonthNameFrench+' '+thisYear+'</p><p style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">Voici les sorties dominicales (G1) programm√©es pour le mois de '+thismonthNameFrench+'¬†:</p>'+'<div style="font-family: Verdana, Geneva, sans-serif;"><table style="border-collapse: collapse;"><tr><td><strong>Date</strong></td><td><strong>D√©part</strong></td><td><strong>Heure</strong></td><td><strong>Parcours</strong></td><td><strong>Pause Caf√©</strong></td><td><strong>Dist (km)</strong></td><td><strong>D√©niv (m)</strong></td></tr>';

  // This month...
  for (const row of data) {
 //       if (row.Date == null) break;

 //             console.log(convertDDMMYYYToDate(row.Date));
        if ((convertDDMMYYYToDate(row.Date).getMonth() == thisDate.getMonth()) && (convertDDMMYYYToDate(row.Date).getFullYear() == thisDate.getFullYear()))
            {
          url = 'https://chr1sg1thub.github.io/TownsOnMap/?gpxFile='+row.Parcours+'.gpx&clat='+row.PCLat+'&clon='+row.PCLon+'&dist='+row.Distance+'&deniv='+row.Denivele;
          
          thisMonth = new Date(convertDDMMYYYToDate(row.Date).getFullYear(), convertDDMMYYYToDate(row.Date).getMonth(), 1);
          monthNameFrenchShort = thisMonth.toLocaleString('fr-FR', { month: 'short' });
          dayAndMonth = convertDDMMYYYToDate(row.Date).getDate() + ' ' + monthNameFrenchShort;
          hour = row.HeuredeDepart.substring(0,2)+"h"+row.HeuredeDepart.substring(3,5);
          monthHTML +=
                `<tr><td>${dayAndMonth}</td><td>${row.PointdeDepart}</td><td>${hour}</td><td><a href='${url}' target="_blank">${row.Parcours}</a></td><td>${row.PauseCaf√©}</td><td>${row.Distance}</td><td>${row.Denivele}</td></tr>`;
                
        } //if (convertDDMMYYYToDate(row.Date).getMonth() > thisDate.getMonth() + 1)
      } //for (const row of data)
      monthHTML += '</table></div>';
      document.getElementById("acpTable2").innerHTML = monthHTML;

  // Next month... 
  monthHTML = '<p style="font-family: Verdana, Geneva, sans-serif; font-size: 24px">Sorties (G1) programm√©es de '+nextmonthNameFrench+' '+yearOfNextMonth+'</p><p style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">Voici les sorties dominicales (G1) programm√©es pour le mois de '+nextmonthNameFrench+'¬†:</p>'+'<div style="font-family: Verdana, Geneva, sans-serif;"><table style="border-collapse: collapse;"><tr><td><strong>Date</strong></td><td><strong>D√©part</strong></td><td><strong>Heure</strong></td><td><strong>Parcours</strong></td><td><strong>Pause Caf√©</strong></td><td><strong>Dist (km)</strong></td><td><strong>D√©niv (m)</strong></td></tr>';

      for (const row of data) {
//        if (row.Date == null) break;
        url = 'https://chr1sg1thub.github.io/TownsOnMap/?gpxFile='+row.Parcours+'.gpx&clat='+row.PCLat+'&clon='+row.PCLon+'&dist='+row.Distance+'&deniv='+row.Denivele;

 //             console.log(convertDDMMYYYToDate(row.Date));
        const dataMonth = convertDDMMYYYToDate(row.Date).getMonth();
        const realMonth = nextMonth.getMonth();
        const dataYear = convertDDMMYYYToDate(row.Date).getFullYear();
        
        if ((dataMonth == realMonth) && (dataYear == yearOfNextMonth)) {
          thisMonth = new Date(convertDDMMYYYToDate(row.Date).getFullYear(), convertDDMMYYYToDate(row.Date).getMonth(), 1);
          monthNameFrenchShort = nextMonth.toLocaleString('fr-FR', { month: 'short' });

          dayAndMonth = convertDDMMYYYToDate(row.Date).getDate() + ' ' + monthNameFrenchShort;
          hour = row.HeuredeDepart.substring(0,2)+"h"+row.HeuredeDepart.substring(3,5);
          monthHTML +=
                `<tr><td>${dayAndMonth}</td><td>${row.PointdeDepart}</td><td>${hour}</td><td><a href='${url}' target="_blank">${row.Parcours}</a></td><td>${row.PauseCaf√©}</td><td>${row.Distance}</td><td>${row.Denivele}</td></tr>`;
                
        } //if (convertDDMMYYYToDate(row.Date).getMonth() > thisDate.getMonth() + 1)
      } //for (const row of data)
      monthHTML += '</table></div>';
      document.getElementById("acpTable3").innerHTML = monthHTML;

  } //main()

////////////////////////////////////////////////////////////////////////////////////////

main();

    </script>
  </body>
</html>
