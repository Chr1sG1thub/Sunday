<html>
  <head>
    <script src="https://unpkg.com/stein-js-client"></script>
    <style>
      table, tr, td {
        border: 1px solid;
        border-color: lightgray;
      }
    </style>
  </head>
  <body>
    <div id="acpSignal"></div>
    <div id="acpBlurb1"></div>
    <div id="acpTable"></div>
    <div id="acpBlurb2"></div>
  <hr/>
    <div id="acpTable2"></div>

    <script>

      let theLink;

async function extractFirstLinkContainingText(url, searchText) {
  const proxyUrl = 'https://api.allorigins.win/get?url=';
  const response = await fetch(proxyUrl + encodeURIComponent(url));
  const data = await response.json();
  const parser = new DOMParser();
  const doc = parser.parseFromString(data.contents, 'text/html');

  const links = [...doc.querySelectorAll('a')];
  const link = links.find(a => a.textContent.toLowerCase().includes(searchText.toLowerCase()));

  if (link) {
    return link.href;
  } else {
    return null;
  }
}

theLink = extractFirstLinkContainingText('https://acprades.fr', 'dimanche');

    function parseDateDDMMYYYY(dateStr) {
  const parts = dateStr.split('/');
  // parts[0] = day, parts[1] = month, parts[2] = year
  return new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
}

  function addDays(date, days) {
  const result = new Date(date);       // Clone the original date to avoid mutation
  result.setDate(result.getDate() + days);  // Add the number of days
  return result;
}

const theYear = "2025";
      
  const thisDate = new Date();
  const nextMonth = new Date(thisDate.getFullYear(), thisDate.getMonth() + 1, 1);
const monthNameFrench = nextMonth.toLocaleString('fr-FR', { month: 'long' });
    
      const store = new SteinStore(
        "https://api.steinhq.com/v1/storages/6905c247affba40a62139941"
      );

      store.read("Ride Plan "+theYear)
        .then(data => {
          
    for (const row of data) {
  if (row.Date == null) break;
 //             console.log(parseDateDDMMYYYY(row.Date));
              if (parseDateDDMMYYYY(row.Date) > thisDate) {
              document.getElementById("acpSignal").innerHTML =
                `Demain, pour le G1, départ de ${row.PointdeDepart} à ${row.HeuredeDepart}. Détails ici : ${theLink}<br/><hr>`;
        
                break;
              } //if (parseDateDDMMYYYY(row.Date)) > thisDate
          } //for (const row of data)

          for (const row of data) {
  if (row.Date == null) break;
 //             console.log(parseDateDDMMYYYY(row.Date));
      let theDate2 = parseDateDDMMYYYY(row.Date).getDate();
      let thisMonth = new Date(thisDate.getFullYear(), thisDate.getMonth(), 1);
const monthNameFrench2 = thisMonth.toLocaleString('fr-FR', { month: 'long' });
              if (parseDateDDMMYYYY(row.Date) > thisDate) {
              document.getElementById("acpBlurb1").innerHTML =
                `<p style="font-family: Verdana, Geneva, sans-serif; font-size: 24px">Sortie du dimanche ${theDate2} ${monthNameFrench2} ${theYear}</p><div style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">
                 <img src = "ACP Logo.png" width=142px>&nbsp;Bonjour à toutes et tous,<br/><br/>
                 <span style="color: red"><strong>G1 et G2 rdv à ${row.PointdeDepart} à ${row.HeuredeDepart}.</strong></span>
                 <p>Le rendez-vous pour les sorties organisées par le club sont diffusées sur le blog et/ou Signal.
                 Si le lieu du départ est modifié vous serez informés via la messagerie du club.</p>

                 <p>Après la pause-café, deux groupes pourront être constitués en fonction des participants et de leur niveau de forme.</p>
                 <p style="color: red"><strong>Parcours proposé pour le G1 :</strong></p></div>`;
        
              document.getElementById("acpTable").innerHTML =
                `<div style="font-family: Verdana, Geneva, sans-serif;">
                   <table width=100%>
                     <tr><td colspan=2 align=center>[Image here]</td></tr>
                     <tr><td><strong>Parcours</strong></td><td>${row.Parcours}</td></tr>
                     <tr><td><strong>Dist (km)</strong></td><td>${row.Distance}</td></tr>
                     <tr><td><strong>Déniv (m)</strong></td><td>${row.Denivele}</td></tr>
                     <tr><td><strong>Café</strong></td><td>${row.PauseCafé}</td></tr>
                     <tr><td><strong>Itinéraire</strong></td><td><a href="${row.Strava}" target="_blank">Itinéraire</a></td></tr>
                     <tr><td><strong>Trace (GPX)</strong></td><td><a href="xxx">Trace</a></td></tr>
                   </table>
                 </div>`;
       
              document.getElementById("acpBlurb2").innerHTML =
                `<div style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">
                   <p style="color: red"><strong>Parcours proposé pour le G2</strong></p>
                   <p>(Voir Signal si pas de publication ici …)</p>
                 </div>`;
                break;
              } //if (parseDateDDMMYYYY(row.Date)) > thisDate
          } //for (const row of data)
 
             let monthHTML = '<p style="font-family: Verdana, Geneva, sans-serif; font-size: 24px">Sorties (G1) programmées de '+monthNameFrench+' '+theYear+'</p><p style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">Voici les sorties dominicales (G1) programmées pour le mois de '+monthNameFrench+' :</p>'+'<div style="font-family: Verdana, Geneva, sans-serif;"><table style="border-collapse: collapse;"><tr><td><strong>Date</strong></td><td><strong>Départ</strong></td><td><strong>Heure</strong></td><td><strong>Parcours</strong></td><td><strong>Pause Café</strong></td><td><strong>Dist (km)</strong></td><td><strong>Déniv (m)</strong></td></tr>';
let dayAndMonth;
          let thisMonth;
          let monthNameFrenchShort;

          for (const row of data) {
  if (row.Date == null) break;
 //             console.log(parseDateDDMMYYYY(row.Date));
              if (parseDateDDMMYYYY(row.Date).getMonth() == thisDate.getMonth() + 1) {
                            thisMonth = new Date(parseDateDDMMYYYY(row.Date).getFullYear(), parseDateDDMMYYYY(row.Date).getMonth(), 1);
const monthNameFrenchShort = thisMonth.toLocaleString('fr-FR', { month: 'short' });

        dayAndMonth = parseDateDDMMYYYY(row.Date).getDate() + ' ' + monthNameFrenchShort;
              monthHTML +=
                `<tr><td>${dayAndMonth}</td><td>${row.PointdeDepart}</td><td>${row.HeuredeDepart}</td><td><a href="${row.Strava}" target="_blank">${row.Parcours}</a></td><td>${row.PauseCafé}</td><td>${row.Distance}</td><td>${row.Denivele}</td></tr>`;
                
              } //if (parseDateDDMMYYYY(row.Date).getMonth() > thisDate.getMonth() + 1)
          } //for (const row of data)
          monthHTML += '</table></div>';
          document.getElementById("acpTable2").innerHTML = monthHTML;

        } //data =>
      ); //.then

    </script>
  </body>
</html>
