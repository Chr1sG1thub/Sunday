<html>
  <head>
    <title>Sunday</title>
    <script src="https://unpkg.com/stein-js-client"></script>
    <style>
      table, tr, td {
        border: 1px solid;
        border-color: lightgray;
      }
    </style>
  </head>
  <body>
  <!--  <div id="acpSignal" style="font-size: 40px;"></div> -->
    <div id="acpBlurb1"></div>
    <div id="acpTable"></div>
    <div id="acpBlurb2"></div>
    <hr/>
    <div id="acpTable2"></div>
    <hr/>
    <div id="acpTable3"></div>


    <script>
////////////////////////////////////////////////////////////////////////////////////////
function ddmmyyyyToYyyymmdd(dateStr) {
  //Converts date string in form dd/mm/yyyy to date string in form yyyymmdd.
  const [dd, mm, yyyy] = dateStr.split('/');
  return `${yyyy}${mm}${dd}`;
}

////////////////////////////////////////////////////////////////////////////////////////
function ddmmyyyyToYyyydashmmdashdd(dateStr) {
  //Converts date string in form dd/mm/yyyy to date string in form yyyymmdd.
  const [dd, mm, yyyy] = dateStr.split('/');
  return `${yyyy}-${mm}-${dd}`;
}

//console.log(ddmmyyyyToYyyymmdd("31/12/2025")); // "20251231"
////////////////////////////////////////////////////////////////////////////////////////  
function convertDDMMYYYToDate(dateStr) {
  //Converts date string in form dd/mm/yyyy to a JS date.
  const parts = dateStr.split('/');
  // parts[0] = day, parts[1] = month, parts[2] = year
  return new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
}
////////////////////////////////////////////////////////////////////////////////////////
function addDays(date, days) {
  //Adds a number of days to a date.
  const result = new Date(date);       // Clone the original date to avoid mutation
  result.setDate(result.getDate() + days);  // Add the number of days
  return result;
}

      ////////////////////////////////////////////////////////////////////////////////////////
  async function getGpxBounds(gpxFilename) {
  try {
    // Fetch the GPX file as text from the server
    const response = await fetch(gpxFilename);
    if (!response.ok) {
      throw new Error(`Failed to fetch GPX file: ${response.status}`);
    }
    const gpxText = await response.text();
    
    // Parse the GPX XML content
    const parser = new DOMParser();
    const gpxDoc = parser.parseFromString(gpxText, 'text/xml');
    
    // Extract all trackpoint elements (<trkpt>)
    const trackPoints = Array.from(gpxDoc.getElementsByTagName('trkpt'));
    
    if (trackPoints.length === 0) {
      throw new Error('No trackpoints found in GPX file');
    }
    
    // Initialize bounds with first point
    const firstPoint = trackPoints[0];
    let minLat = parseFloat(firstPoint.getAttribute('lat'));
    let maxLat = minLat;
    let minLon = parseFloat(firstPoint.getAttribute('lon'));
    let maxLon = minLon;
    
    // Iterate through all trackpoints to find bounds
    for (let i = 1; i < trackPoints.length; i++) {
      const point = trackPoints[i];
      const lat = parseFloat(point.getAttribute('lat'));
      const lon = parseFloat(point.getAttribute('lon'));
      
      if (lat < minLat) minLat = lat;
      if (lat > maxLat) maxLat = lat;
      if (lon < minLon) minLon = lon;
      if (lon > maxLon) maxLon = lon;
    }
    
    return {
      minLat,
      maxLat,
      minLon,
      maxLon
    };
  } catch (error) {
    console.error('Error processing GPX file:', error);
    throw error;
  }
}

      ////////////////////////////////////////////////////////////////////////////////////////
async function main() {
        
  const thisDate = new Date();
  const thisYear = thisDate.getFullYear();
  let nextMonth, yearOfNextMonth;
  //console.log(thisDate.getMonth());
  if (thisDate.getMonth() == 11) { //December - months are counted from zero
    nextMonth = new Date(thisYear + 1, 0, 1);
    yearOfNextMonth = thisYear + 1;
  } else {
    nextMonth = new Date(thisYear, thisDate.getMonth() + 1, 1);
    yearOfNextMonth = thisYear;
  }
  const thismonthNameFrench = thisDate.toLocaleString('fr-FR', { month: 'long' });
  const nextmonthNameFrench = nextMonth.toLocaleString('fr-FR', { month: 'long' });
    
  const store = new SteinStore(
    "https://api.steinhq.com/v1/storages/692da1acaffba40a62246e38"
  );

  let data2025, data2026, data;
  
  try {
    data2025 = await store.read("Ride Plan 2025");
 } catch (error) {
    console.error("Failed to load ride data:", error);
  } //try-catch
   try {
    data2026 = await store.read("Ride Plan 2026");
 } catch (error) {
    console.error("Failed to load ride data:", error);
  } //try-catch
  
const getValidLength = (arr) => {
  return arr.findIndex(row => 
    !row ||                           // Empty row
    row.Date == null ||               // null/undefined
    row.Date === '' ||                // Empty string
    row.Date === 'null'               // String "null"
  );
};


const len2025 = getValidLength(data2025);
const len2026 = getValidLength(data2026);
  data = [
  ...data2025.slice(0, len2025),
  ...data2026.slice(0, len2026)
];
  
 // Next date...
  for (const row of data) {
 //       if (row.Date == null) break;  //Stop at the end of the year.
 //             console.log(convertDDMMYYYToDate(row.Date));
        if (convertDDMMYYYToDate(row.Date) > thisDate) {
          let theDate2 = convertDDMMYYYToDate(row.Date).getDate();
          let imageFilename = '/Sunday/images/'+ddmmyyyyToYyyymmdd(row.Date)+'.png';
          let thisMonth = new Date(convertDDMMYYYToDate(row.Date).getFullYear(), convertDDMMYYYToDate(row.Date).getMonth(), 1);
          let thisYear = convertDDMMYYYToDate(row.Date).getFullYear();
          const monthNameFrench2 = thisMonth.toLocaleString('fr-FR', { month: 'long' });
          const hour = row.HeuredeDepart.substring(0,2)+"h"+row.HeuredeDepart.substring(3,5);
          const url = 'https://chr1sg1thub.github.io/TownsOnMap/index.html?gpxFile='+row.Parcours+'.gpx&clat='+row.PCLat+'&clon='+row.PCLon+'&dist='+row.Distance+'&deniv='+row.Denivele;

          const gpxFile = "https://raw.githubusercontent.com/Chr1sG1thub/TownsOnMap/main/gpx/"+row.Parcours+".gpx";
          
          let bounds = getGpxBounds(gpxFile);  

    document.getElementById("acpBlurb1").innerHTML =
                `<p style="font-family: Verdana, Geneva, sans-serif; font-size: 24px">Sortie du dimanche ${theDate2} ${monthNameFrench2} ${thisYear}</p><div style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">
                 <img src = "ACP Logo.png" width=142px>&nbsp;Bonjour Ã  toutes et tous,<br/><br/>
                 <span style="color: red"><strong>G1 et G2Â rdv Ã  ${row.PointdeDepart} Ã  ${hour}.</strong></span>
                 <p>Le rendez-vous pour les sorties organisÃ©es parÂ leÂ club sont diffusÃ©es sur le blog et/ou Signal.
                 Si le lieu duÂ dÃ©part est modifiÃ© vous serez informÃ©s via la messagerie du club.</p>

                 <p>AprÃ¨s la pause-cafÃ©, deux groupes pourront Ãªtre constituÃ©s en fonction des participants et de leur niveau de forme.</p>
                 <p style="color: red"><strong>Parcours proposÃ© pour le G1 :</strong></p></div>`;
          const dateWithDashes = ddmmyyyyToYyyydashmmdashdd(row.Date);
        
          document.getElementById("acpTable").innerHTML =
                `<div style="font-family: Verdana, Geneva, sans-serif;">
                   <table width=100%>
                     <tr><td colspan=2 align=center><a href='${url}' target='_blank'><img src='${imageFilename}' width=90%></a><br>ðŸ‘€&nbsp;<i>Pour une version zoomable, avec les Points d'Eau prÃ¨s de la route <img src='allwater.jpg' title='Toilette, Robinet, Fontaine, Autre' width=88px> cliquez <span style='background-color: yellow;'>sur la carte</span> ou <a href='${url}' target='_blank' style='font-size: 24px; background-color: yellow;'>ici</a>.</i>&nbsp;ðŸ‘€<br/></td></tr>
                     <tr><td><strong>Parcours</strong></td><td>${row.Parcours}</td></tr>
                     <tr><td><strong>Parcours DÃ©taillÃ©</strong></td><td style="font-size: 10px;">${row.Details}</td></tr>
                     <tr><td><strong>Dist (km)</strong></td><td>${row.Distance}</td></tr>
                     <tr><td><strong>DÃ©niv (m)</strong></td><td>${row.Denivele}</td></tr>
                     <tr><td><strong>CafÃ©</strong></td><td>${row.PauseCafÃ©}</td></tr>
                     <tr><td><strong>ðŸ‘€MÃ©tÃ©oðŸ‘€</strong></td><td>ðŸ‘€<a href="https://chr1sg1thub.github.io/WeatherChart/?date=${dateWithDashes}&depart=${row.PointdeDepart}&latmin=${bounds.minLat}&latmax=${bounds.maxLat}&lonmin=${bounds.minLon}&lonmax=${bounds.maxLon}" target="_blank">PrÃ©visions MÃ©tÃ©o</a>ðŸ‘€</td></tr>
                     <tr><td><strong>ItinÃ©raire</strong></td><td><a href="${row.Strava}" target="_blank">ItinÃ©raire</a></td></tr>
                     <tr><td><strong>Trace (GPX)</strong></td><td><a href="https://drive.google.com/file/d/${row.FileId}/view?usp=drive_link">Trace</a></td></tr>
                   </table>
                 </div>`;
       
          document.getElementById("acpBlurb2").innerHTML =
                `<div style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">
                   <p style="color: red"><strong>Parcours proposÃ© pour le G2</strong></p>
                   <p>(Voir Signal si pas de publication ici â€¦)</p>
                 </div>`;
          break;
        } //if (convertDDMMYYYToDate(row.Date)) > thisDate
      } //for (const row of data)
 
      let dayAndMonth;
      let thisMonth;
      let monthNameFrenchShort;
      let hour;
      let monthHTML;
          
      monthHTML = '<p style="font-family: Verdana, Geneva, sans-serif; font-size: 24px">Sorties (G1) programmÃ©es de '+thismonthNameFrench+' '+thisYear+'</p><p style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">Voici les sorties dominicales (G1) programmÃ©es pour le mois de '+thismonthNameFrench+'Â :</p>'+'<div style="font-family: Verdana, Geneva, sans-serif;"><table style="border-collapse: collapse;"><tr><td><strong>Date</strong></td><td><strong>DÃ©part</strong></td><td><strong>Heure</strong></td><td><strong>Parcours</strong></td><td><strong>Pause CafÃ©</strong></td><td><strong>Dist (km)</strong></td><td><strong>DÃ©niv (m)</strong></td></tr>';

  // This month...
  for (const row of data) {
 //       if (row.Date == null) break;

 //             console.log(convertDDMMYYYToDate(row.Date));
        if ((convertDDMMYYYToDate(row.Date).getMonth() == thisDate.getMonth()) && (convertDDMMYYYToDate(row.Date).getFullYear() == thisDate.getFullYear()))
            {
          url = 'https://chr1sg1thub.github.io/TownsOnMap/?gpxFile='+row.Parcours+'.gpx&clat='+row.PCLat+'&clon='+row.PCLon+'&dist='+row.Distance+'&deniv='+row.Denivele;
          
          thisMonth = new Date(convertDDMMYYYToDate(row.Date).getFullYear(), convertDDMMYYYToDate(row.Date).getMonth(), 1);
          monthNameFrenchShort = thisMonth.toLocaleString('fr-FR', { month: 'short' });
          dayAndMonth = convertDDMMYYYToDate(row.Date).getDate() + ' ' + monthNameFrenchShort;
          hour = row.HeuredeDepart.substring(0,2)+"h"+row.HeuredeDepart.substring(3,5);
          monthHTML +=
                `<tr><td>${dayAndMonth}</td><td>${row.PointdeDepart}</td><td>${hour}</td><td><a href='${url}' target="_blank">${row.Parcours}</a></td><td>${row.PauseCafÃ©}</td><td>${row.Distance}</td><td>${row.Denivele}</td></tr>`;
                
        } //if (convertDDMMYYYToDate(row.Date).getMonth() > thisDate.getMonth() + 1)
      } //for (const row of data)
      monthHTML += '</table></div>';
      document.getElementById("acpTable2").innerHTML = monthHTML;

  // Next month... 
  monthHTML = '<p style="font-family: Verdana, Geneva, sans-serif; font-size: 24px">Sorties (G1) programmÃ©es de '+nextmonthNameFrench+' '+yearOfNextMonth+'</p><p style="font-family: Verdana, Geneva, sans-serif; font-size: 16px">Voici les sorties dominicales (G1) programmÃ©es pour le mois de '+nextmonthNameFrench+'Â :</p>'+'<div style="font-family: Verdana, Geneva, sans-serif;"><table style="border-collapse: collapse;"><tr><td><strong>Date</strong></td><td><strong>DÃ©part</strong></td><td><strong>Heure</strong></td><td><strong>Parcours</strong></td><td><strong>Pause CafÃ©</strong></td><td><strong>Dist (km)</strong></td><td><strong>DÃ©niv (m)</strong></td></tr>';

      for (const row of data) {
//        if (row.Date == null) break;
        url = 'https://chr1sg1thub.github.io/TownsOnMap/?gpxFile='+row.Parcours+'.gpx&clat='+row.PCLat+'&clon='+row.PCLon+'&dist='+row.Distance+'&deniv='+row.Denivele;

 //             console.log(convertDDMMYYYToDate(row.Date));
        const dataMonth = convertDDMMYYYToDate(row.Date).getMonth();
        const realMonth = nextMonth.getMonth();
        const dataYear = convertDDMMYYYToDate(row.Date).getFullYear();
        
        if ((dataMonth == realMonth) && (dataYear == yearOfNextMonth)) {
          thisMonth = new Date(convertDDMMYYYToDate(row.Date).getFullYear(), convertDDMMYYYToDate(row.Date).getMonth(), 1);
          monthNameFrenchShort = nextMonth.toLocaleString('fr-FR', { month: 'short' });

          dayAndMonth = convertDDMMYYYToDate(row.Date).getDate() + ' ' + monthNameFrenchShort;
          hour = row.HeuredeDepart.substring(0,2)+"h"+row.HeuredeDepart.substring(3,5);
          monthHTML +=
                `<tr><td>${dayAndMonth}</td><td>${row.PointdeDepart}</td><td>${hour}</td><td><a href='${url}' target="_blank">${row.Parcours}</a></td><td>${row.PauseCafÃ©}</td><td>${row.Distance}</td><td>${row.Denivele}</td></tr>`;
                
        } //if (convertDDMMYYYToDate(row.Date).getMonth() > thisDate.getMonth() + 1)
      } //for (const row of data)
      monthHTML += '</table></div>';
      document.getElementById("acpTable3").innerHTML = monthHTML;

  } //main()

////////////////////////////////////////////////////////////////////////////////////////

main();

    </script>
  </body>
</html>
